git:
  depth: 3
sudo: required
services:
  - docker
language: java # default is oracle JDK 1.8.0_151
jdk:
  - oraclejdk8
addons:
  apt:
    packages:
      - "python3"
      - "python3-pip"
# TODO: build matrix for different database and benchmarks
# https://docs.travis-ci.com/user/environment-variables/#Defining-Multiple-Variables-per-Item
env:
# --- begin tpcc with different databases ---
  - BENCH=tpcc DB=mysql
  - BENCH=tpcc DB=postgres
  - BENCH=tpcc DB=tidb
#  - BENCH=tpcc DB=memsql # FIXME: too many errors that exceeded travis log limit (4MB)
# --- end tpcc with different databases ---
# --- begin benchmarks using mysql ---
  - BENCH=auctionmark DB=mysql 
  # - BENCH=chbenchmark DB=mysql # FIXME: too many error https://travis-ci.org/benchhub/oltpbench/jobs/338773148
  - BENCH=epinions DB=mysql
  # - BENCH=hyadapt DB=mysql # TODO: no config
  # - BENCH=jpab DB=mysql # TODO: no ddl
  - BENCH=linkbench DB=mysql
  - BENCH=noop DB=mysql
  - BENCH=resourcestresser DB=mysql
  - BENCH=seats DB=mysql
  - BENCH=sibench DB=mysql
  - BENCH=smallbank DB=mysql
  - BENCH=tatp DB=mysql
  # - BENCH=tpcc DB=mysql # dup
  # - BENCH=tpch DB=mysql # TODO: require db gen
  # - BENCH=tpcds DB=mysql # TODO: wonder how it worked, it didn't update plugin.xml when we were still using it
  - BENCH=twitter DB=mysql # TODO: move traces location
  - BENCH=voter DB=mysql
  - BENCH=wikipedia DB=mysql
  - BENCH=ycsb DB=mysql
# --- end benchmarks using mysql --- 
# --- begin other databases ---
  - BENCH=ycsb DB=cassandra
# --- end other databases ---
# https://stackoverflow.com/questions/34377017/what-are-the-differences-between-the-before-install-script-travis-yml-opti
before_install:
  - python3 --version
  - sudo pip3 install pyyaml
  - java -version
  - docker version
  - docker-compose version
  # check if common ports are already in use, travis starts a bunch of DBMS by default ....
  - sudo netstat -nlp | grep :3306
  - sudo netstat -nlp | grep :5432
  - sudo service mysql stop
  - sudo service postgresql stop
# https://docs.travis-ci.com/user/database-setup/#Multiple-Database-Builds
install:
  - ant build
  - ./docker/travis_start.sh
before_script:
  - ./config/config.py validate
script:
  - ./config/config.py generate --bench ${BENCH} --db ${DB} --scalefactor 1
  - ./oltpbenchmark --bench ${BENCH} --config config/generated_${BENCH}_${DB}_config.xml --create true --load true --execute true
after_script:
  - ./docker/travis_stop.sh